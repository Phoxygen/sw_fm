<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1">
    <meta charset="utf-8" />
    <meta name="theme-color" content="#242d33">

    <script type="text/javascript">
      (function() {
        'use strict';

        var server;
        var client;

        function debug(str, args) {
          console.log.bind(console, '[smuggler]').apply(console, arguments);
        };

        function getServer(url) {
          var w = document.createElement('iframe');
          //w.hidden = true;
          w.src = url;

          setTimeout(function() {
            document.body.appendChild(w);
          });

          return {
            postMessage: function(msg) {
              debug('postmessage ready');
              w.contentWindow.postMessage(msg, '*');
            },
            terminate: function() {
              document.body.removeChild(w);
              w = null;
            }
          };
        };

        var channel = new BroadcastChannel('smuggler');
        channel.onmessage = function(msg) {
          switch (msg.data.name) {
            case 'register':
              register(msg.data);
              break;

            case 'unregister':
              unregister(msg.data);
              break;

            default:
              throw new Error('Not Implemented: ' + msg.data.name);
              break;
          }
        };


        // TODO: Add version support
        var kEmptyRegistration = 'Empty registration are not allowed.';
        function register(registration) {
          if (!registration) {
            throw new Error(kEmptyRegistration);
          }

          switch (registration.type) {
            case 'client':
              client = registration.uuid;
              server = getServer('servers/index.html');
              server.registered = false;

              break;

            case 'server':

              // start can fail
              if (server) {
                server.postMessage({ type: 'register' });
                server.ready = true;
              }

              break;

            default:
              throw new Error(registration.type + ': ' + kUnknowRegistrationType);
              break;
          }
        };

        function unregister(registration) {

          switch (registration.type) {
            case 'client':
              debug('Unregistering client');
              // unregister in the smuggler
              client = null;
              if (server && server.ready) {
                // unregister in the server
                server.postMessage({ type: 'unregister' });
              }
              break;
            case 'server':
              debug('Unregistering server');
              if (server) {
                server.ready = false;
                server.terminate();
                server = null;
              }
              break;
            default:
              throw new Error(registration.type + ': ' + kUnknowRegistrationType);
              break;
          }
        };

      })();

      (function(exports) {
      'use strict';

      function ClientFactory() {
        return createNewClient();
      }

      function createNewClient() {

        function sendToSmuggler(clientInternal, command) {
          debug('sendToSmuggler', command);
          var smuggler = new BroadcastChannel('smuggler');
          smuggler.postMessage({
            name: command,
            type: 'client',
          });
          smuggler.close();
        }

        /*
         * Client
         */
        function Client() {
          this.server = null;
          this.connect();
        }

        Client.prototype.unregister = function() {
          sendToSmuggler(this, 'unregister');
        };

        Client.prototype.connect = function() {
          debug(' [connect]');

          sendToSmuggler(this, 'register');
          this.server = new BroadcastChannel('logic');
          this.listen();
        };

        Client.prototype.disconnect = function() {
          debug(' [disconnect]');
          this.unregister();
        }

        Client.prototype.ondisconnected = function() {
          debug(' [disconnected]');

          this.server.removeEventListener('message', this.server.listener);
          this.server.close();
          this.server = null;
        };

        Client.prototype.listen = function() {
          this.server.listener = e => this.onmessage(e);
          this.server.addEventListener('message', this.server.listener);
        };

        Client.prototype.onmessage = function(e) {
          debug('on message', e.data);

          switch (e.data.type) {
            case 'disconnected':
              this.ondisconnected();
              break;

            default:
              throw new Error('Not implemented', e.data);
              break;
          }
        };

        var client = new Client();

        return client;
      }

      /*
       * Utils
       */

      function debug() {
        console.log.bind(console, '[client]').apply(console, arguments);
      }


      exports.Client = ClientFactory;
      })(this);
    </script>
    <!--<script async src="bridge/smuggler.js"></script>-->
    <!--<script async src="bridge/client.js"></script>-->
  </head>

  <body>
    <h1>Test leak</h1>
    <button onclick="removeIframe()">
      Remove the iframe
    </button>
    <script type="text/javascript">
      function removeIframe() {
        logicAPI.disconnect();
      }

      setTimeout(function() {
        window.logicAPI = new Client('logic');
      }, 100);

    </script>
  </body>
</html>
