<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
  </head>
  <body>
    <h1>Test leak</h1>
    <button onclick="removeIframe()">
      Remove the iframe
    </button>
    <script type="text/javascript">

      var iframe = null;
      var channel = new BroadcastChannel('smuggler');
      channel.onmessage = function(msg) {
        switch (msg.data.name) {
          case 'unregister':
            debug('Unregistering server');
            iframe.terminate();
            iframe = null;
            break;

          default:
            throw new Error('Not Implemented: ' + msg.data.name);
            break;
        }
      };

      function getServer(url) {
        var w = document.createElement('iframe');
        w.src = url;

        setTimeout(function() {
          document.body.appendChild(w);
        });

        return {
          postMessage: function(msg) {
            debug('postmessage ready');
            w.contentWindow.postMessage(msg, '*');
          },
          terminate: function() {
            document.body.removeChild(w);
            w = null;
          }
        };
      }

      iframe = getServer('servers/index.html');
      iframe.registered = false;


      function debug() {
        console.log.bind(console, '[client]').apply(console, arguments);
      }

      function removeIframe() {
        iframe.postMessage({ type: 'unregister' });
      }
    </script>
  </body>
</html>
