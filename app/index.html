<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1">
    <meta charset="utf-8" />
    <meta name="theme-color" content="#242d33">

    <script type="text/javascript">
      function getClient() {

        var iframe = null;
        var channel = new BroadcastChannel('smuggler');
        channel.onmessage = function(msg) {
          switch (msg.data.name) {
            case 'unregister':
              debug('Unregistering server');
              iframe.terminate();
              iframe = null;
              break;

            default:
              throw new Error('Not Implemented: ' + msg.data.name);
              break;
          }
        };

        function getServer(url) {
          var w = document.createElement('iframe');
          w.src = url;

          setTimeout(function() {
            document.body.appendChild(w);
          });

          return {
            postMessage: function(msg) {
              debug('postmessage ready');
              w.contentWindow.postMessage(msg, '*');
            },
            terminate: function() {
              document.body.removeChild(w);
              w = null;
            }
          };
        }

        /*
         * Client
         */
        function Client() {
          debug(' [connect]');

          iframe = getServer('servers/index.html');
          iframe.registered = false;

        }

        Client.prototype.disconnect = function() {
          debug(' [disconnect]');
          iframe.postMessage({ type: 'unregister' });
        }

        Client.prototype.onmessage = function(e) {
          debug('on message', e.data);

          switch (e.data.type) {
            case 'disconnected':
              debug(' [disconnected]');

              break;

            default:
              throw new Error('Not implemented', e.data);
              break;
          }
        };

        var client = new Client();

        return client;
      }

      /*
       * Utils
       */

      function debug() {
        console.log.bind(console, '[client]').apply(console, arguments);
      }


    </script>
  </head>

  <body>
    <h1>Test leak</h1>
    <button onclick="removeIframe()">
      Remove the iframe
    </button>
    <script type="text/javascript">
      function removeIframe() {
        logicAPI.disconnect();
        //document.body.removeChild(document.querySelector('iframe'));
      }

      setTimeout(function() {
        window.logicAPI = getClient();
      }, 100);

    </script>
  </body>
</html>
